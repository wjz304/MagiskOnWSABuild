#
# Copyright (C) 2022 Ing <https://github.com/wjz304>
# 
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#


name: Custom MagiskOnWSAL

on:
  issues:
    types: [opened, reopened]
  workflow_dispatch:
    inputs:
      body: 
        description: 'issuss body'
        required: true
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Create Issues comment
        if: github.event_name == 'issues'
        id: comment
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: | 
            ÂàÜÊûê title Âíå body ÂÜÖÂÆπ ..  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
          emoji: heart

      - name: Set up Python 3
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Init Env
        run : |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"

          python -m pip install --upgrade pip setuptools

      - name: Get Issues Info
        if: github.event_name == 'issues'
        id: get-issues
        uses: actions/github-script@v6
        with:
          script: |
            // '<???>': ÊõøÊç¢‰∏ÄÊ¨°; '/<???>/g': ÊõøÊç¢ÂÖ®Â±Ä; '/<???>/gi': ÊõøÊç¢ÂÖ®Â±ÄÂπ∂ÂøΩÁï•Â§ßÂ∞èÂÜô; 
            // \u0008 \b Backspace
            // \u0009 \t Tab
            // \u000A \n Êç¢Ë°åÁ¨¶
            // \u000B \v ÂûÇÁõ¥Âà∂Ë°®Á¨¶
            // \u000C \f Êç¢È°µ
            // \u000D \r ÂõûËΩ¶
            // \u0022 \" ÂèåÂºïÂè∑ (")
            // \u0027 \' ÂçïÂºïÂè∑ (')
            // \u005C \\ ÂèçÊñúÊù† (\)
            // \u00A0    ‰∏çÈó¥Êñ≠Á©∫Ê†º
            // \u2028    Ë°åÂàÜÈöîÁ¨¶
            // \u2029    ÊÆµËêΩÂàÜÈöîÁ¨¶
            // \uFEFF    Â≠óËäÇÈ°∫Â∫èÊ†áËÆ∞

            var fs = require('fs'); // ÂºïÂÖ•fsÊ®°Âùó
            var issuenumber = ${{ toJSON(github.event.issue.number) }};
            var issueauth = ${{ toJSON(github.event.issue.user.login) }};
            var issuetitle = ${{ toJSON(github.event.issue.title) }};
            var issuebody = ${{ toJSON(github.event.issue.body) }};

            if (issuetitle != null) {
              issuetitle = issuetitle.replace(/\u000A|\u000D/g, "");  // Êç¢Ë°åÁ¨¶,ÂõûËΩ¶
            }
            
            if (issuebody != null) {
              // Backspace,Tab,ÂûÇÁõ¥Âà∂Ë°®Á¨¶,Êç¢È°µ,Êç¢Ë°åÁ¨¶,ÂõûËΩ¶,‰∏çÈó¥Êñ≠Á©∫Ê†º,Ë°åÂàÜÈöîÁ¨¶,ÊÆµËêΩÂàÜÈöîÁ¨¶,Â≠óËäÇÈ°∫Â∫èÊ†áËÆ∞
              issuebody = issuebody.replace(/\u0008|\u0009|\u000A|\u000B|\u000C|\u000D|\u00A0|\u2028|\u2029|\uFEFF/g, "");
              
              // ÂÆπÈîô
              issuebody = issuebody.replace(/‚Äî/g, "-");  // ‰∏≠ÊñáÊ®™Á∫ø
            }
            core.setOutput("issuenumber", JSON.stringify(issuenumber));
            core.setOutput("issueauth", JSON.stringify(issueauth));
            core.setOutput("issuetitle", JSON.stringify(issuetitle));
            core.setOutput("issuebody", JSON.stringify(issuebody));

      - name: Set Issues Info
        if: github.event_name == 'issues' && success()
        run: |
          echo issuenumber: '${{ steps.get-issues.outputs.issuenumber }}'
          echo issueauth:   '${{ steps.get-issues.outputs.issueauth }}'
          echo issuetitle:  '${{ steps.get-issues.outputs.issuetitle }}'
          echo issuebody:   '${{ steps.get-issues.outputs.issuebody }}'

          echo "issuenumber="${{ steps.get-issues.outputs.issuenumber }}"" >> $GITHUB_ENV
          echo "issueauth="${{ steps.get-issues.outputs.issueauth }}"" >> $GITHUB_ENV
          echo "issuetitle="${{ steps.get-issues.outputs.issuetitle }}"" >> $GITHUB_ENV
          echo "issuebody="${{ steps.get-issues.outputs.issuebody }}"" >> $GITHUB_ENV

      - name: Get Build Info
        shell: python
        run: |
          import os, re, json, shutil, string, subprocess

          def set_output(name, value):
              subprocess.call(["echo '{}={}' >> $GITHUB_ENV".format(name, value)], shell=True)

          if __name__ == '__main__':

              issues = 'false'
              iscustom = 'true'
              errinfo = ''
              body = ''

              try:
                  body = ''

                  if '${{ github.event_name }}' == 'issues':
                      if '${{ env.issuetitle }}'.lower().startswith('custom'):
                          issues = 'true'
                          body = '${{ env.issuebody }}'
                      else:
                          iscustom = 'false'
                  else:
                      body = '${{ inputs.body }}'

                  if len(body) == 0:
                      iscustom = 'false'
                      errinfo = 'body ÈîôËØØ, body is null'

              except Exception as e:
                  iscustom = 'false'
                  errinfo = 'body ÈîôËØØ, {}.'.format(e)

              set_output('issues', issues)
              set_output('iscustom', iscustom)
              set_output('errinfo', errinfo)
              set_output('body', body)

      - name: Echo Build Info
        run: |
          echo issues:            '${{ env.issues }}'
          echo iscustom:          '${{ env.iscustom }}'
          echo errinfo:           '${{ env.errinfo }}'
          echo body:              '${{ env.body }}'

      - name: Add Issues labels
        if: env.issues == 'true' && env.iscustom == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'add-labels'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}
          labels: 'custom,${{ env.platform }}'

      - name: Update Comment Begin
        if: env.issues == 'true' && env.iscustom == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.  
            ÊÇ®Ëá™ÂÆö‰πâÁöÑ MagiskOnWSA Â∑≤ÂºÄÂßãÊûÑÂª∫. ËØ∑ÂâçÂæÄ‰∏ãÈù¢ÁöÑ URL Êü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ.  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
          emoji: heart

      - name: Update Comment Error
        if: env.issues == 'true' && env.iscustom == 'false'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.  
            ÊÇ®Ëá™ÂÆö‰πâ MagiskOnWSA ÊâÄÂ°´ÂÜôÁöÑ‰ø°ÊÅØÊúâËØØ, Êó†Ê≥ïËß¶ÂèëÁºñËØë, ËØ∑ÂèÇËÄÉÊ®°ÊùøÂíåÈîôËØØÊèêÁ§∫ÂØπbodyËøõË°å‰øÆÊîπÂπ∂ËØ∑ÈáçÊñ∞Ëß¶ÂèëÁºñËØë(Close & Reopen).  
            `Error Info:`  
            `${{ env.errinfo }}`  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
          emoji: confused

      - name: Update Comment Invalid
        if: env.issues == 'false'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.  
            Ê†πÊçÆ title Âíå body ÂÜÖÂÆπÁöÑÂàÜÊûê, ËØ• Issue Âπ∂ÈùûÂÆöÂà∂ MagiskOnWSA. Â∞ÜÂú®ÁÆ°ÁêÜÂëòÁúãÂà∞Âêé‰ºöËøõË°åÂõûÂ§ç.  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ----
          emoji: eyes

      - name: Run Build
        if: env.iscustom == 'true' && success()
        shell: bash
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt install setools lzip wine patchelf e2fsprogs aria2 attr -y
          python -m pip install requests

          # ÂºÄÂßãË°®Êºî
          echo "============================ÁºñËØë============================"

          repo=https://github.com/LSPosed/MagiskOnWSALocal
          branch=main

          git clone -b ${branch} ${repo} MagiskOnWSA
          cd MagiskOnWSA/scripts
          
          # ÂéüÂáΩÊï∞Âú®action‰∏ã‰ºöÂç°Ê≠ª
          Gen_Rand_Str() {
              head -n 100 /dev/urandom | tr -dc '[:lower:]' | head -c $1
          }
          export -f Gen_Rand_Str
          sed -i 's/Gen_Rand_Str()/Gen_Rand_Str_bak()/g' ./build.sh

          ./build.sh ${{ env.body }}

      - name: Generate release tag
        if: env.iscustom == 'true' && success()
        id: tag
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV

          if [ ${{ env.issues }} == 'true' ]; then
            echo "### ${{ env.issueauth }}'s MagiskOnWSA Custom" >> $GITHUB_STEP_SUMMARY
            echo "üëâ issues: [#${{ env.issuenumber }}](${{ github.event.issue.html_url }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ${{ github.triggering_actor }}'s MagiskOnWSA Custom" >> $GITHUB_STEP_SUMMARY
            echo "üëâ "platform": "${{ env.platform }}"  " >> $GITHUB_STEP_SUMMARY
            echo "üëâ "version": "${{ env.version }}"  " >> $GITHUB_STEP_SUMMARY
            echo "üëâ "ext": "${{ env.ext }}"  " >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload to Artifacts
        if: env.iscustom == 'true' && success()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ github.event.repository.name }}-Custom-${{ env.release_tag }}
          path: |
            MagiskOnWSA/output/*

      - name: Generate release tag
        if: env.iscustom == 'false'
        run: |
          if [ ${{ env.issues }} == 'true' ]; then
            echo "### ${{ env.issueauth }}'s MagiskOnWSA Custom" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ${{ github.triggering_actor }}'s MagiskOnWSA Custom" >> $GITHUB_STEP_SUMMARY
          fi
          echo "üòû üòî üòü üòï üôÅ ‚òπÔ∏è üò£ üòñ üò´ üò© ü•∫ üò¢  " >> $GITHUB_STEP_SUMMARY
          echo "ÊÇ®Ëá™ÂÆö‰πâ MagiskOnWSA ÊâÄÂ°´ÂÜôÁöÑ‰ø°ÊÅØÊúâËØØ, Êó†Ê≥ïËß¶ÂèëÁºñËØë, ËØ∑ÂèÇËÄÉÊ®°ÊùøÂíåÈîôËØØÊèêÁ§∫ÂØπbodyËøõË°å‰øÆÊîπÂπ∂ËØ∑ÈáçÊñ∞Ëß¶ÂèëÁºñËØë(Close & Reopen).  " >> $GITHUB_STEP_SUMMARY
          echo "`Error Info:`  " >> $GITHUB_STEP_SUMMARY
          echo "`${{ env.errinfo }}`  " >> $GITHUB_STEP_SUMMARY

      - name: Update Comment Finish
        if: env.issues == 'true' && env.iscustom == 'true' && success()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.
            ÊÇ®Ëá™ÂÆö‰πâÁöÑ MagiskOnWSA Â∑≤ÊûÑÂª∫ÂÆåÊàê. ËØ∑ÂâçÂæÄ‰∏ãÈù¢ÁöÑ URL ‰∏ãËΩΩ.  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----  
            PS:  
            Âú®Issues‰∏ãËØÑËÆ∫ "transfer" ÈôÑ‰ª∂ËΩ¨Âø´‰º† üö≤->üèç. (ËØ∑ÂãøÈáçÂ§çÂèë, Êìç‰ΩúÊó∂Èó¥ ‚âà ÊàêÂäü‰∏™Êï∞ X 3ÂàÜÈíü). 
            Âú®Issues‰∏ãËØÑËÆ∫ "delete builds" Âç≥ÂèØÂà†ËØ•IssuesÁöÑÊâÄÊúâÂéÜÂè≤ÁºñËØëËÆ∞ÂΩï.
            >  
            ----  
          emoji: hooray

      - name: Close Issues
        if: env.issues == 'true' && env.iscustom == 'true' && success()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}

      - name: Update Comment Fail
        if: env.issues == 'true' && env.iscustom == 'true' && failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} ÊÇ®Â•Ω.
            ÊÇ®Ëá™ÂÆö‰πâÁöÑ MagiskOnWSA ÊûÑÂª∫Â§±Ë¥•. ËØ∑ÂâçÂæÄ‰∏ãÈù¢ÁöÑ URL Êü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØÂØπbodyËøõË°å‰øÆÊîπÂπ∂ËØ∑ÈáçÊñ∞Ëß¶ÂèëÁºñËØë(Close & Reopen).  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
            PS:  
            Âú®Issues‰∏ãËØÑËÆ∫ "delete builds" Âç≥ÂèØÂà†ËØ•IssuesÁöÑÊâÄÊúâÂéÜÂè≤ÁºñËØëËÆ∞ÂΩï.
            >  
            ----  
          emoji: confused
